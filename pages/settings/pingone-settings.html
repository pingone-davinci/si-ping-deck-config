<div id="pageDiv">
  <span class="xsmall">Saved to browser local storage</span>
  <hr>
    <fieldset name="pingone" id="settings">
      <div class="form-row">
        <label title="variable: {{region}}">PingOne Region:</label>
        <select id="region">
          <option value="com">NorthAmerica (US)</option>
          <option value="ca">NorthAmerica (Canada)</option>
          <option value="eu">Europe</option>
          <option value="asia">Asia Pacific</option>
        </select></div>
      <div class="form-row">
        <label title="variable: {{envId}}">PingOne Environment ID:</label>
        <input id="envId" type="text" value=""></div>
      <div class="form-row">
        <label title="variable: {{username}}">PingOne Username:</label>
        <input id="username" type="text" value=""></div>
      <div class="form-row">
        <label title="variable: {{password}}">PingOne Password:</label>
        <input id="password" type="password" value=""></div>
      <div class="form-row">
        <label></label><button id="dvlogin" class="action-button blue">Login/Refresh DaVinci Companies</button></div>
      <div class="form-row">
        <label title="variable: {{companyId}}">PingOne Environments (w/ DaVinci):</label>
        <select id="companyId">
        </select></div>
    </fieldset>
</div>

<div id="scriptDiv">
  <script>
  /**
    * refreshPingOneEnviromentsSelect
    */
    function refreshPingOneEnvironmentsSelect(settingsGroup, settingId, optionsStorage) {
      const select = document.getElementById(settingId);
      const value = getSetting(settingsGroup, settingId)

      select.innerHTML = "";
      let options = {};

      if (optionsStorage) {
        options = JSON.parse(localStorage.getItem(optionsStorage)) || {};
      }

      // console.log("Options = ", options);

      Object.keys(options)
        .forEach(function eachKey(key) {
          const option = document.createElement("option");
          option.value = options[key];
          option.innerHTML = key;
          // console.log(`key = ${options[key]} ... value = ${value}}`)
          if (options[key] == value) {
            option.selected = true;
          }
          select.appendChild(option);
        });


    }


    /**
    *
    * dvlogin
    * Login to DaVinci
    *
    */
    const dvlogin = async function () {
      const env = getSetting("pingone", "envId");
      const username = getSetting("pingone", "username");
      const password = getSetting("pingone", "password");
      const region = getPingOneRegion();
      let accessToken = undefined;

      localStorage.removeItem("davinci_access_token");
      localStorage.removeItem("davinci_companies");

      if (!env || !username || !password) {
        redAlert("Missing DaVinci Preferences");
      } else {
        blueAlert("Logging in...")
        const response = await fetch("/api/dvlogin",
          {
            method: "POST",
            body: JSON.stringify({
              env,
              username,
              password
            }),
            headers: {
              "Content-Type": "application/json",
              "Accept": "application/json",
              "x-p1-region": region
            }
          });

        let resp = await response.json();

        accessToken = resp?.access_token;
        companies = resp?.companies;
        if (accessToken && companies) {
          localStorage.setItem("davinci_access_token", accessToken);
          localStorage.setItem("davinci_companies", JSON.stringify(companies));
          greenAlert("PingOne/Davinci Login Successful")
        } else if (resp?.message) {
          redAlert(resp.message);
        } else {
          redAlert("Unable to Login");
        }
      }

      refreshPingOneEnvironmentsSelect("pingone", "companyId", "davinci_companies");
    }

    function pingone_init() {
      // Whatever
      console.log("pagescript - pingone_init()")

      const fieldset = document.getElementById("settings");

      fieldset.onchange = saveSettingsToLocalStorage;

      const button = document.getElementById("dvlogin");
      button.onclick = dvlogin;

      refreshPingOneEnvironmentsSelect(fieldset.name, "companyId", "davinci_companies");
      getSettingsFromLocalStorage(fieldset.name);
    }
    pingone_init();

  </script>
</div>